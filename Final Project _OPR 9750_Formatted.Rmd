---
title: "Statistical Analysis of the House Price in New York City"
author: "Deyoz Rayamajhi, Yaw Mawuli, Rahat Mahmud"
date: '2022-05-20'
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



# Introduction

New York city (NYC), which has five boroughs - New York, Kings, Queens, Bronx and Staten Island -  is considered one of the most expensive city in the world, particularly for the housing. However, the city is so diverse that the house prices vary significantly across the its neighborhoods. It would be therefore, very interesting to know the factors that influence the house prices, and also to determine the degree of variations in the house price across the regions within the city. For this purpose, we studied and performed the statistical analysis and developed the multivariate regression model to understand multiple explanatory variables that can predict the house price in NYC reasonably. Moreover, we also performed regression analysis to examine the relationship between average house-price per zip code and total population per zip code in NYC. Furthermore, we performed the exploratory and descriptive analysis to determine the average house price by county, zip codes and also house type. We have also developed the machine learning algorithms to predict the crime level.
From the multivariate regression, we found that the number of bathrooms, bedrooms and level of the nightlife activities are the most important determinants of the house price. The number of schools in the area and square feet are other explanatory variables. 
Surprisingly, we found that there is no correlation between average house price and population per zip code.
As expected the most expensive zip codes for the house price are in New York County, but we have found that house price in kings is also high, particularly in Western and Northern Brooklyn. Interestingly, we have found that the house price in Staten Island is least among all the boroughs, followed by Bronx and Queens. 

First section of this document discusses about the data set we used to perform the analysis. Second, the cleaning and preparation. Third, some exploratory and descriptive analysis to examine the distribution, outliers, and relationship of the of the variables. Fourth section is the multivariate Regression Model. In fifth section, we have developed the machine learning model to predict the crime level. Sixth section is uni-variate regression analysis. Seventh is descriptive statistics that present the aggregated data by by the different categorical variables.  The last section present the average price per zipcode visualized in the NYC map. In the last section we conclude. 

This document is prepared as a final project for the partial completion the graduate course STA/OPR 9750 at Baruch College, New York. This document is based on the general instructions set in the project guidelines posted in blackboard by Prof. Jean Francois Collard (Jeff). We also declare that all the work done for the project is original work. 


# Section 1: The Datasets
For the purpose of the analysis, we used the housing data that was available in Kaggle, an open source platform for data analysis. The link of the data set is embedded [here](https://www.kaggle.com/datasets/parv619/newyork-house-sale-data).
Second data that we have used is population of NYC by zipcode which we have extracted from [this](https://data.cityofnewyork.us/Business/Zip-Code-Boundaries/i8iw-xf4u). We have use this dataset also for our map visualization.

```{r warning = FALSE,message = FALSE }
housing_data = read.csv('D://MSBA//Second Sem//OPR 9750//Project//Housesell//data_lat_long2.csv//project_opr.csv')
```
```{r, echo = FALSE, include = FALSE, eval = TRUE}
head(housing_data,30)
```

This uploaded dataset contains information of New York City neighborhood housings. The raw  data contains some variables we do not need for our analysis, so we will begin by viewing   and reading the structure of the data, then we clean up  the dating after reading it to keep  only variables that are needed for our work. Also, variables that are characters may be converted into numeric and vice versa  when necessary for the  purpose of our analysis.


# Section 2: Data Cleaning and Preparation 

In this section, we read, examine and clean to make the data set useful to our analysis. 


***import required basic libraries***


```{r warning=FALSE, message=FALSE}
library(tidyverse)
library(dplyr)
library(stringi)
library(miscset)


```

***Examining the structure of the dataset***

```{r, include = FALSE, eval  = FALSE}
str(housing_data)
```
It is observed that the data is very raw and needs massive cleaning and in some instance needs extractions, We therefore begin with the cleaning for pur data preparation.


***Removing Unwanted characters from  bath, bed, and sqft variables and changing their type to numeric***

As it is observed from the structure of dataframe that bath, bed and sqft variables have type character instead of numeric, and is because of the additional characters in the values. So, we first remove those unwanted characters.
```{r}

housing_data$bath = gsub(" .*",'',housing_data$bath)

housing_data$bed = gsub(" .*",'',
                        gsub("Studio", "0",housing_data$bed))

housing_data$sqft = gsub(" .*",'',housing_data$sqft)
```
Remove the $ sign and comma separator in the values of the variables tax, land.assessment.cost, improvement.cost, total.cost and sqft.
```{r warning = FALSE, message = FALSE}

housing_data$tax = gsub("\\$",'',
                    gsub(',','',housing_data$tax))

housing_data$land.assessment.cost = gsub("\\$",'',
                    gsub(',','',housing_data$land.assessment.cost))

housing_data$improvement.cost = gsub("\\$",'',
                    gsub(',','',housing_data$improvement.cost))

housing_data$total.cost = gsub("\\$",'',
                    gsub(',','',housing_data$total.cost))

housing_data$sqft = gsub("\\$",'',
                    gsub(',','',housing_data$sqft))
```


***Convert variables in to numeric***

```{r, warning = FALSE, message = FALSE, include = FALSE, eval = TRUE}
housing_data[, c('sqft', 'tax', 'land.assessment.cost', 'improvement.cost', 'total.cost')]= sapply(housing_data[, c('sqft', 'tax', 'land.assessment.cost', 'improvement.cost', 'total.cost')],as.numeric)
```

Counting Unique values of bath and bed variables
```{r warning = FALSE, message = FALSE}
ggplotGrid(ncol = 2,
  lapply(c("bed", "bath"),
    function(col) {
        ggplot(housing_data,aes_string(col)) + geom_bar() + coord_flip() 
    }))
```
As it can bee seen from the above bar diagrams that there are some missing values, so we assign NA to those missing values by converting those to numeric. 

```{r warning = FALSE, message = FALSE, include = FALSE, eval = TRUE}
housing_data[, c('bed', 'bath')]= sapply(housing_data[, c('bed', 'bath')],as.numeric)
```


```{r warning = FALSE, message = FALSE, include= FALSE, eval = TRUE }

colSums(is.na(housing_data))
```

***Extracting ZIP Codes and number of schools***
```{r warning = FALSE, message = FALSE}
housing_data['zipcode'] = gsub(".*NY ","", housing_data$address)
housing_data['schools'] = gsub("[^0-9]","",housing_data$school.information) 
housing_data$schools = as.numeric(housing_data$schools)
```
 
***Removing unwanted characters from estimated.mortgage***
```{r warning = FALSE, message = FALSE}
housing_data$estimated.mortage = gsub(".*\\$", '', 
                                      gsub("/.*",'', 
                                           gsub(",", "", housing_data$estimated.mortage)))
housing_data$estimated.mortage = as.numeric(housing_data$estimated.mortage)
```

***Extracting Number of Restaurant, Groceries and Nightlife***
```{r warning = FALSE, message = FALSE}
housing_data['Restaurant'] = gsub(".*Eat", '', 
                                  gsub('Restaurants.*','', housing_data$shop.and.eat.information))
    

housing_data['Groceries'] = gsub(".*Restaurants", '', 
                                 gsub('Groceries.*','', housing_data$shop.and.eat.information))

housing_data['Nightlife'] = gsub(".*Groceries", '', 
                                 gsub('Nightlife.*','', housing_data$shop.and.eat.information))


housing_data[, c('Restaurant', 'Groceries', 'Nightlife')]= sapply(housing_data[, c('Restaurant', 'Groceries', 'Nightlife')],as.numeric)

```

***Extracting Crime information, Commute Information, Housing Type ***
```{r warning = FALSE, message = FALSE}
housing_data['crime.level'] = gsub(".*Crime", '',
                                   gsub('crime.*', '', 
                                        gsub('Learn about.*', 'Unknown', housing_data$crime.information)))


housing_data['per.commute.car'] = gsub(".*Commute", '',
                                   gsub('%.*', '', housing_data$commute.information))
housing_data$per.commute.car = as.numeric(housing_data$per.commute.car)


housing_data['housing.type'] = gsub('/sqft.*', '',
                                    gsub(',.*', '', 
                                         gsub('Home.*', '', housing_data$home.details)))
```


***Merging Datasets to get the county variables***
```{r warning = FALSE, message = FALSE}
new_data = read.csv("D://MSBA//Second Sem//OPR 9750//Project//Housesell//data_lat_long2.csv//population1.csv")
new_data['zipcode'] = new_data$ï..zip
housing_data$zipcode = as.integer(housing_data$zipcode)
housing_data = inner_join(housing_data, new_data, by = 'zipcode')
housing_data = housing_data %>% select(c(-ï..zip, -pop))
```

***Dropping unnecessary columns from the dataSet***
```{r warning = FALSE, message = FALSE}
drop = c('X', "linktoproperty", 'provider.info', 'what.local.say.about.the.neighborhood','neighborhood.name', "shop.and.eat.information", "school.information", "commute.information","seo.description", "crime.information", "description","comparable.properties", "address", 'comments.of.residents.and.previous.residents', 'home.details', 'price.details')

df_housing = housing_data[,!(names(housing_data) %in% drop)]
```
***Checking Missing Values***
### Barplot of missing values 
``` {r warning = FALSE, message = FALSE}
missing.values <- df_housing %>%
    gather(key = "key", value = "val") %>%
    mutate(is.missing = is.na(val)) %>%
    group_by(key, is.missing) %>%
    summarise(num.missing = n()) %>%
    filter(is.missing==T) %>%
    select(-is.missing) %>%
    arrange(desc(num.missing)) 

missing.values %>%
  ggplot() +
    geom_bar(aes(x=key, y=num.missing), stat = 'identity') +
    labs(x='variables', y="number of missing values", title='Number of missing values') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
***Omitting records of missing values in price***
Because price has the maximum number of missing values, and it is both difficult and unwarranted to estimate the price of the missing values, so we will omit all the records, which has missing values in Price. 

```{r warning = FALSE, message = FALSE}
df_housing.nona = na.omit(df_housing)
#colSums(is.na(df_housing.nona))
```
Now, we do not have any missing values. So, let us explore the data using descriptive statistics. 

***Converting the schools variable to n_schools by taking the sum of digits***

```{r}
total_schools = c()
digitsum2 <- function(x) sum(floor(x / 10^(0:(nchar(x) - 1))) %% 10)
for (i in df_housing.nona$schools){
  total_schools = append(total_schools, digitsum2(i))
}

df_housing.nona$n_schools = total_schools
```



# Section 3: Data Explorations and Descriptive Statistics 

In this section we explore the data set to check some descriptive statistics. W examine the correlation between the variables using scatter plot, check outliers and summaries of data using box plot . We further examine the scatter plots also using categorical variables. 

```{r, eval  = FALSE, include = FALSE}
summary(df_housing.nona)
```

```
It can be observed from the summary statistics of the data set that there are outliers. for example square feet, minimum is 1 and is ourlier. We will examine the outliers in more detail in subsequent subsections.
Let's examine the distribution of the all numeric variables. 

```{r echo = FALSE, warning = FALSE}
df_housing.nona %>% 
  keep(is.numeric) %>% 
  select(-Lon, -Lat) %>% 
  gather() %>% 
  ggplot(aes(value)) + geom_histogram() + 
  facet_wrap(~key, scales = "free")
  
```
It is observed that the distributions of most of the numeric variables are highly skewed to the right and therefore required transformations. 
let's examine the scatter plot of all the numeric variables against the price to see the correlations.

```{r echo= FALSE, warning = FALSE}
df_housing.nona %>% 
  keep(is.numeric) %>% 
  select(-Lon, -Lat) %>% 
  pivot_longer(-Price) %>% 
  ggplot(aes(value, Price)) + geom_point() +
  scale_y_log10() + scale_x_log10() +
  facet_wrap(~name)
```
From the scatter plot, it can be observed that there is positive correlation between house price and these numeric variables. 

***Checking Correlation between numeric variables and price***
```{r echo  = FALSE}

corr_table = df_housing.nona %>% 
  select_if(is.numeric) %>% 
  select(-Lon, -Lat, -estimated.mortage) %>% 
  pivot_longer(-Price) %>% 
  group_by(name) %>% 
  summarize(corr = cor(Price, value)) %>% 
  arrange(-abs(corr)) 
knitr::kable(corr_table, col.names = gsub("[.]", " ", names(corr_table)))
```
We ignore the zip code in the correlation above as it is the categorical variable. Apart from the per.commute.car, all other variables are positively correlated with price. 

## Examining outliers and the distribution 

***Box Plot of house price by several categorical variable***

```{r}
boxplot_price = function(x){
  (df_housing.nona %>%
     mutate(Price = Price/1e3) %>%
    ggplot(aes(Price, {{x}}))+ geom_boxplot()+
                 scale_x_log10(labels = scales ::comma)+
                 labs(x = "price in '000", title = "Boxplot of Price ")+
                 theme(plot.margin = margin(10,50,10,0)))

}
  
```
### Boxplot of Price by housing Type 
```{r}

boxplot_price(housing.type)
```

As it can be seen that there are points which lies below and above of whisker of each boxplots. However, these points may not be the outliers, because it is possible that single family house price can range from $40,000 to $79,000,000, given the diverse location within the New York City and other factors such as size, type, etc. Therefore, we do not treat these points as outliers. Among median price of all the house type, median price of townhouse is highest. This is consistent with the fact that townhouses are most expensive on an average. There are other house type, which price are much more than townhouse, this is because of the prime location in Manhattan and Southern Brooklyn.

### Boxplot of Price by county
```{r}

boxplot_price(county)
```
From the above the boxplot of price by county in NYC, the median price of the houses in New York county is way more than the median prices of the houses in other counties. However, there are houses in counties that are also very expensive, as indicated by the fourth quantile and points above the whiskers of these box plots. This is reasonable because of some prime locations with in this counties. 


### Box Plot of Price by cri.level
```{r}

boxplot_price(crime.level)
```
It can be observed that the median price of the house in the area where crime is lowest is higher than that in the area where crime is high. 



*** Box Plot of house price by numeraical variables***

```{r}
boxplot_numerics = function (x){
  (df_housing.nona %>%
     ggplot(aes({{x}}, Price, group = {{x}}))+
     geom_boxplot()+scale_y_log10())
  
}
```
### Box plot of Price by number of bed
```{r}

boxplot_numerics (bed)
```
It is observed that the high median price of house, which has more number of bedrooms. However,  median prices are
relatively low for the houses, which has more than 10 bedrooms, as compare to the houses, which has 8 or 9 bedrooms. This is likely due to the drop in house price, which has increasingly number of set of bedrooms than single bedrooms. 

### Boxplot of Price by number of bath
```{r}

boxplot_numerics(bath)
```
It is observed that the high median price of house, which has more number of bathrooms. However,median prices are
relatively low for the houses, which has more than 10 bathrooms, as compared to the houses, which has 8 or 9 bathrooms. This is likely due to the drop in house price, which has increasingly number of set of bathrooms than single bathroom. 


### Boxplot of Price by number of schools
```{r}

boxplot_numerics (n_schools)
```
It is observed that the median prices of houses are high, in the areas, where there are more than 7 schools. More often than not, the higher the number of schools in the neighborhood, higher the house prices. 


## Scatterplot of Price against numerical and categorical variables 
```{r}
lmplot_numerics = function (x){
  df_housing.nona %>%
  ggplot(aes({{x}}, Price, color = fct_lump(county, 6))) +
    geom_point() +
    scale_x_log10() + scale_y_log10()
} 

```


```{r}
lmplot_numerics(tax)

```
it is observed that there is a positive correlation between tax and house price. However, since tax depend on house prices, we will not use tax as predictor for house price. 



```{r}
lmplot_numerics(sqft)
```
We observed that there is strong positive correlation between house price and square feet. We also see that the house prices based in square feet is higher in New York county, followed by kings, Richmond, the Bronx and then Queens.


```{r} 
lmplot_numerics(total.cost)
```

We observed that there is positive correlation between total cost, which is the sum of land assessment cost and house improvement cost, and house price. 
```{r}
lmplot_numerics(Groceries)
```
We observed that there is positive relationship between house price and number of groceries in a neighborhood. 
```{r}
lmplot_numerics(Nightlife)
```

We observed that there is positive relationship between house price and number of nightlife in a neighborhood.

```{r}
lmplot_numerics(n_schools)
```
We observed that there is no clear pattern of correlation between house prices in a neighborhood and the number of schools in that neighborhood from our multiple regression analysis.

```{r}
lmplot_numerics(Restaurant)

```
We observed that there is positive relationship between house price and number of restaurant in a neighborhood



# Section 4: Development of model to predict the house price in NYC using Multi-Linear Regression 

Since,  n_schools, Nightlife, Restaurants, Groceries, sqft, tax, bed, bath and total cost all affect house Price. We will develop a model using multi-variate regression model that best predicts the house price.

### Examining the correlation between the independent variables

```{r, echo = FALSE}

 model = df_housing.nona %>%
  select(Price, tax, improvement.cost, bed, bath, Groceries, 
         Nightlife, Restaurant, sqft, n_schools) %>%
  filter_if(is.numeric, all_vars(. > 0))

 model_corr = model %>% cor()
#knitr::kable(model_corr, col.names = gsub("[.]", " ", names(model_corr)))

```
As it can be seen that tax is highly correlated with improvement.cost, so we exclude tax. Likewise bed and bath have positive correlation but we include both of them as they are different variables. Similarly, Nightlife, Restaurant and Groceries,  we include only Nightlife. 

### Updated model 

```{r}
model.updated = lm(log(model$Price) ~ 
                     log(model$bath) +
                     log(model$improvement.cost) + 
                     log(model$n_schools) +
                     log(model$Nightlife) +
                     log(model$bed)+ 
                     log(model$sqft))
                     
           
summary(model.updated)
```



The p - values for total cost is very high, so we do not reject the hypothesis that their betas's values are 0. But, those for the other predictors (n_schools, Nightlife, bath and sqft, bed) are very small, hence we can conclude that their slopes are not 0. 


Now, lets run the multiple regression with remaining five variables. 

```{r}
model.updated = lm(log(model$Price) ~ 
                     log(model$bath) +
                     log(model$n_schools) +
                     log(model$Nightlife) +
                     log(model$bed)+ 
                     log(model$sqft))
                     
           
summary(model.updated)

```
from the revised summary of multiple regression analysis, we observer that p values of all the variables are less than 0.05, indicating that they are highly significant.This implies that we do not accept the null hypothesis that the house price is not dependent on these variables. Hence we conclude that these variables are very strong predictors for house prices.


```{r}
library(broom)

```
# Regression Plot of the fitted model 
```{r}
reg.model = augment(model.updated) %>% 
  ggplot(aes(x = .fitted, 
             y =`log(model$Price)`)) + 
  geom_point(alpha = 0.4) + 
  geom_abline() +
  labs (title ="Fitted Model",
        subtitle = "Price regress on bath, bed, Nightlife, n_schools, sqft")
reg.model
```

Obviously, there is a high  positive correlation between house prices and the dependent variables which are bath, bed, square feet, number of schools, nightlife.These predictors are the necessary variables from the data in estimating house prices in neighborhoods of NYC. The implication here is, knowing these information which are easy to come by without having access to the data will educate the general public on a better estimation of house price with little to no knowledge of data analysis.




### Ressidual plot of the fitted model 
```{r, echo = FALSE}
res.plot = augment(model.updated) %>% 
  mutate(residual = .fitted - `log(model$Price)`) %>% 
  ggplot(aes(.fitted, residual)) + 
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0) 
res.plot
```
From the diagnostic test of the residuals, it is observed that the variance of the residuals are nicely stabilized, even though there are few points that are scattered to the right. Therefore, model is valid and is a good estimator of house prices. 

### Histogram of residuals of fitted model


```{r, echo = FALSE}
hist(residuals(model.updated))
```
the nicely normally distributed histogram of residuals is an evidence that the valid model.


# Section 5: Machine learning Model

In this section we build a machine learning model to predict the crime level of the location in NYC based on nightlife, n_schools, housing.type, and per.commute.car.

### Prediction of Crime level (crime.level) based in the other categorical variable

***copy the cleaned dataset for KNN*** 
```{r}
knn = df_housing.nona
```
***change all the variables names to lower case.***

```{r, echo = FALSE, include = FALSE, eval  = TRUE }
variable.names = tolower(colnames(knn))
colnames(knn) = variable.names
head(knn)
```
***Import required libraries***
```{r, echo = FALSE, warning = FALSE}
library (tidyverse)
library(ggvis)
library(class)
library (recipes)
library(crosstable)
library(gmodels)
```
***Data Preparation for KNN Model*** 
Since KNN in distance based algorithm, it requires all the predictive variables in numeric type. so we convert all the variables to the numeric. Also, we create a dummy variabe of all the nominal type categorical variables, and scale the variables to standardize using standard scaler.

```{r, echo = FALSE, include = FALSE, eval = TRUE }

cl_outcome = knn %>% select(crime.level)

knn = knn %>% select(c( nightlife, n_schools, housing.type, per.commute.car )) 
rec = recipe(~ housing.type, data = knn)
dummy = rec %>%
  step_dummy(housing.type, one_hot = TRUE) %>%
  prep(training = knn)
dummy_one_hot = bake(dummy, new_data = NULL)

dummy_one_hot %>%
  select(starts_with("housing.type")) %>%
  names()
knn_dummy = cbind(knn, dummy_one_hot)
knn_dummy = knn_dummy %>% select (-one_of(
  c('housing.type')))
knn_dummy[, c(1:10)] = scale(knn_dummy[, c(1:10)])

```


***Split the data into the training and test sets***

We partition 70% of the data into the training set and the remaining 25% into the test set

```{r}
set.seed (3000)
smp_size = floor (0.75 * nrow(knn_dummy))

train_ind = sample(seq_len(nrow(knn_dummy)), size = smp_size)

class_pred_train = knn_dummy[train_ind, ]
class_pred_test = knn_dummy[-train_ind, ]
```
Split outcome variable into training and test sets using the same partition as above

```{r}
cl_outcome_train = cl_outcome[train_ind, ]
cl_outcome_test = cl_outcome[-train_ind, ]
```
***Run K-NN Classification***
we take k = 41 (approx value of the square root of the 1171, which is the total number of training sets)

```{r}
cl_pred = knn(train = class_pred_train, test = class_pred_test, cl = cl_outcome_train, k = 5)
```
***Model evaluation***


```{r, echo = FALSE, eval = TRUE, include = FALSE}

cl_outcome_test = data.frame(cl_outcome_test)
class_comparison = data.frame(cl_pred, cl_outcome_test)
names(class_comparison) = c('Predicted_Cl', 'Observed_Cl')
head(class_comparison)
```

***Create confusion table***

```{r echo = FALSE, eval = TRUE, include = FALSE}
(consusionMatrix = table(Actual_Value = class_comparison $ Observed_Cl, 
                         Predicted_Value = class_comparison$Predicted_Cl))

```

Our model did not performed well, because it classified most of the data points as a lowest. One reason for this poor performance of the model is class imbalance. Since most of the data points are of class lowest (about 70 percent of data points), model learned to classify lowest class but not other class. The solution to improve the model could be to take the balance sample of each class, say 20 percent from each class and tarin the model, using new balanced sample. 

# Section 6: Average house price by zipccode regress on total population by zipcode

Now in this section, we will examine the the relationship between average house price by zipcode and total population by zipcode in New York City. further we will develop the model, using bivariate regression, to predict the house price based on the population.   For this analysis, we will calculate the average house price by zip code, using our main cleaned data set (df_housing.nona), and merge this data set with the another data set called population1 to get the variable called population by zipcode. 

 

*** calculation of average house price by zip code.*** 
```{r, echo = FALSE, include = FALSE, eval = TRUE}

avg.price_zip = aggregate(df_housing.nona$Price, 
                               by = list(df_housing.nona$zipcode), 
                               FUN = mean)
colnames(avg.price_zip) = c('zipcode', 'avg_price')

head(avg.price_zip)
```
***Convert avg.price_zip to a dataframe***

```{r, echo = FALSE, include = FALSE, eval = TRUE}
avg.price_zip = data.frame(avg.price_zip)
avg.price_zip$zipcode = as.numeric(avg.price_zip$zipcode) # we convert this zipcode as integer just to merge the this dataframe with another, that has zipcode in interger type
```
***Loading datasets of Population by zipcode***

```{r, warning = FALSE}
pop_zip = read.csv('D://MSBA//Second Sem//OPR 9750//Project//Housesell//data_lat_long2.csv//population1.csv')
pop_zip['zipcode'] = pop_zip$ï..zip

```


***Merging two datasets (avg.price_zip and pop_zip)***

```{r, warning = FALSE, echo = FALSE}

merge.df = inner_join(avg.price_zip, pop_zip)
```

### Regression Analysis 


***Convert all the integer type variable to the numeric***

```{r, echo = FALSE, include = FALSE, eval = TRUE}
merge.df[, c('avg_price', 'pop')] = sapply(merge.df[, c('avg_price', 'pop')], as.numeric)

```
### Develop the regression model 

```{r}
plot(log (merge.df$pop) , log(merge.df$avg_price),
     xlab = "log(No.of Population)", 
     ylab = "log(Average Price", 
     col = "darkgreen", cex = 1.7, lwd = 0.6, cex.lab = 0.7)
linear_regr = lm( log(merge.df$avg_price)~log(merge.df$pop))
legend("topright", legend = paste('R-squared = ', 
                                 format(summary(linear_regr)
                                        $adj.r.squared, 
                                        digit = 3)), bty = 'n', cex = 0.6)
abline(linear_regr, col = 'red')
title (main = 'Average price regress on total population, by zipcodes in NYC',
       line = 0.6, cex.main = 0.8)
```
### Summary of Regression 
```{r echo = FALSE, eval = TRUE}
summary(linear_regr)
```

The intercept has significant low p-value, however slope has high p-value of 0.8996. Hence we fail to reject null hypothesis that the beta (coefficient) of population is equal to zero, even though  we observe slightly negative correlation between population and house price. 
Normally, we understand that the house price tends to positively correlated with the population, because increase population will increase economic activity, which push price of houses up. However, in the case of New York City, particularly, the New York County, true number of its residents is less as compare to that of others counties of NYC. People commute from other boroughs or even from different states to work and do other economic activities in Manhattan, but they do not live in Manhattan. As an effect, Manhattan has high economic activities which continuously increases house prices, despite low number of actual residents. 
According to the census of 2020, Kings County has population of 2,736,074. Likewise, Queens has 2,405,464. Bronx has 1,472,654 and Richmond has 495,747. It could be true that there could be positive correlation between house price and population, if we do not include New York. But as said, New York City is such a diverse city, even the less densely populated regions are very expensive. For an example,Zip Code 11213 is Crown Heights and is one of the most densely populated regions in Kings and overall NYC, however, average house price is much less than other zipcodes in Kings that has low population. 

it is therefore, population is not a good predictor of house price in NYC. 

We can futher examine by plotting the residuals of fitted line. 
### Residuals vs fitted line 
```{r echo = FALSE, eval = TRUE}
plot(fitted(linear_regr), resid(linear_regr),
     xlab = "fitted_log", ylab = 'residuals_log', main = 'fitted_log vs residuals_log ')
abline(h=0)
```

As it can be observed that despite the stabilized variances, they are very scattered, indicating the high degree of uncertainty. Therefore, the population is not very good predictor of house price.  


```{r echo = FALSE, eval = TRUE, include = FALSE}
hist(residuals(linear_regr))
```
# Section 7: Summarization of House Price by various categorical variable

In this section, we calculate the average house price based on the various categorical variables such as housing type, county, zipcode, crime level. We also determine the top 10 expensive zipcodes and  10 least expensive zipcodes for house price in New York City. 


### Summarization of house price by County 

```{r echo = FALSE, eval = TRUE, include = FALSE}
avg.price_county = aggregate(df_housing.nona$Price, 
                             by = list(df_housing.nona$county),
                             FUN = mean)
colnames(avg.price_county) = c('County', "Average Price")
#title (main = "Average House Price by County")
knitr::kable(avg.price_county, col.names = gsub("[.]", " ", names(avg.price_county)))

```
New York county is the most expensive in NYC for housing, followed by Kings, Queens, Richmond and Bronx. Bronx is the cheapest in terms of housing in NYC. it can also be observed that the difference in average house price in New York County and other counties is huge. 



### Summarization of House Price by House Type

The table below shows the average house price by housing type 

```{r echo = FALSE, eval = TRUE}
avg.price_HouseType = aggregate(df_housing.nona$Price,
                                by= list(df_housing.nona$housing.type),
                                FUN = mean)
colnames(avg.price_HouseType) = c('Housing Type', 'Average Price')
knitr::kable(avg.price_HouseType, col.names = gsub("[.]", " ", names(avg.price_HouseType)))

```
The most expensive type of housing in NYC is townhouse, followed by condos and apartments. 

### Summarization of House Price by crime level
The table below shows the average house price by crime level

```{r echo = FALSE, eval = TRUE}
avg.price_crime = aggregate(df_housing.nona$Price,
                            by = list(df_housing.nona$crime.level),
                            FUN = mean)
colnames(avg.price_crime) = c('Crime Level', "Average Price")


knitr::kable(avg.price_crime, col.names = gsub("[.]", " ", names(avg.price_crime)))
```
Average price of houses are high, in the places, where crime level is lowest. However, there no significant variations in the house prices bases on crime level. 


### 10 most expensive average house price by County, zipcode 
The table below shows the 10 most expensive zip codes in NYC for housing 
```{r echo = FALSE, eval = TRUE, message = FALSE}
top_ten_zip_county = aggregate(df_housing.nona$Price,
                               by = list(df_housing.nona$county, df_housing.nona$zip),
                               FUN = mean)
colnames(top_ten_zip_county) = c('County', 'Zipcode', 'Average Price')
top_ten_zip_county  = top_ten_zip_county %>% top_n (10)
top_ten_zip_county = top_ten_zip_county[order(-top_ten_zip_county$`Average Price`), ]
knitr::kable(top_ten_zip_county, col.names = gsub("[.]", " ", names(top_ten_zip_county)))
```
the 10 most expensive zipcodes for the house price are all in New York County. 10021, which is eastern side of the Central Park, and 10007, which is in lower Manhattan are the most expensive zipcodes for housing in NYC. 

## 10 least expensive average house price by zipcode
The table below shows the 10 most expensive zip codes in NYC for housing 
```{r echo = FALSE, eval = TRUE, message = FALSE} 
least_10_zip_county = aggregate(df_housing.nona$Price,
                                by = list(df_housing.nona$county, df_housing.nona$zipcode), 
                                FUN = mean)
colnames(least_10_zip_county) = c('County', 'Zipcode', 'Average Price')
least_10_zip_county = least_10_zip_county %>%top_n(-10)
least_10_zip_county = least_10_zip_county[order(least_10_zip_county$`Average Price`),]
knitr::kable(least_10_zip_county, col.names = gsub("[.]", " ", names(least_10_zip_county)))
```
the Zipcode 10475 in Bronx, which is western side of Pelham Bay park is the most cheapest zipcode for housing in NYC. The Zipcode 11432 in Queens, which is situated in Hollis in the Jamaica region is also cheap for housing. The zipcode 10039 is in Upper Manhattan is also cheap, which came out as a surprise. 




# Section 8: Visualization of Average House Price by Zipcode in NYC Map
In this section we plot the average house price in NYC by zipcode in the NYC map to visualize the area with varying average house prices. 
# load NYC map data
```{r eco = FALSE, eval = TRUE, include = FALSE}
library(sf)
loc = "D://MSBA//second Sem//OPR 9750//DataSets//ZIP_CODE_040114"
NYCmap = st_read(dsn = loc, layer = "ZIP_CODE_040114")
#str(NYCmap)
plot(st_geometry(NYCmap))
```

## Merging avg.price_zip and NYCmap 

# creating ZIPCODE variable and converting it to numeric 
```{r echo = FALSE, eval  = TRUE, inclde = FALSE}
#avg.price_zip['ZIPCODE'] = as.numeric(avg.price_zip$zipcode)
avg.price_zip$avg_price = as.numeric(avg.price_zip$avg_price)
avg.price_zip$avg_price = log(avg.price_zip$avg_price)
avg.price_zip$ZIPCODE = as.character(avg.price_zip$zipcode)
hist(avg.price_zip$avg_price)
```
```{r, include = FALSE, eval = TRUE, echo = FALSE}
map.df = merge(NYCmap, avg.price_zip, by = 'ZIPCODE')
```

### Ploting average house price by zipcode in NYC map 
```{r}
plot(map.df['avg_price'])


```
The map of New York city depicts the average house price by zipcodes in the NYC. As expected the most expensive zip codes for houses are in the Manhattan. The area is just in west side of the central park as indicated by the brighter yellow color in the map, which is a zipcode of 10021, and is the most expensive zipcode in terms of housing. Another Zipcode 1000,  second most expensive in NYC, which is situated in lower Manhattan, and is also indicated in brighter yellow in the map. The third most expensive zipcode for house price is 10001, which is across the 11th to 5th Avenue from 25th to 33rd street. This is also highlighted in brighter yellow in the map. 

Interestingly, in Brooklyn, 11231 and 11215 are th most expensive zipcodes for housing and they both are situated in the western Brooklyn, just below the lower Manhattan, and is highlighted in brighter red in the map. Then after the regions in the Northern Brooklyn, in the downtown and Williamsburg area. Eastern Brooklyn are cheapest regions. Likewise, in the map it can be observed that there are regions in upper queens, the house price is expensive, but the most expensive zipcode in queens is 11375, which is Forest Hills. The Staten Island and Bronx, in particular, mid and east Bronx have many zip codes that offers cheap housing as compared to the other regions of NYC. 



### House price by zipcode in Richmond County 

the table below shows the average house prices by zipcodes of Richmond County. 
```{r include = TRUE, eval = TRUE, echo = FALSE, message = FALSE}
zip_richmond= aggregate(df_housing.nona$Price,
                               by = list(df_housing.nona$county, df_housing.nona$zip),
                               FUN = mean)
colnames(zip_richmond) = c('County', 'Zipcode', 'Average Price')
zip_richmond  = zip_richmond %>% filter (zip_richmond$County == 'Richmond')
knitr::kable(zip_richmond, col.names = gsub("[.]", " ", names(zip_richmond)))


```


### House price by ten most expensive zipcodesin Kings county
the table below shows the top ten zipcodes in Kings County for average house price

```{r include = TRUE, eval = TRUE, echo = FALSE, message = FALSE}
zip_kings= aggregate(df_housing.nona$Price,
                               by = list(df_housing.nona$county, df_housing.nona$zip),
                               FUN = mean)
colnames(zip_kings) = c('County', 'Zipcode', 'Average Price')
zip_kings  = zip_kings %>% filter (zip_kings$County == 'Kings')
top_ten_zip_kings= zip_kings %>% top_n (10)
top_ten_zip_kings = top_ten_zip_kings[order(-top_ten_zip_kings$`Average Price`), ]
knitr::kable(top_ten_zip_kings, col.names = gsub("[.]", " ", names(top_ten_zip_kings)))


```
###house price by least 10 expensive zipcodes in Kings county
the table below shows the least ten zipcodes in Kings County for average house price
```{r include = TRUE, eval = TRUE, echo = FALSE, message = FALSE}

zip_kings_least= zip_kings %>% filter (zip_kings$County == 'Kings')
least_ten_zip_kings= zip_kings %>% top_n (-10)
least_ten_zip_kings = least_ten_zip_kings[order(least_ten_zip_kings$`Average Price`), ]
knitr::kable(least_ten_zip_kings, col.names = gsub("[.]", " ", names(least_ten_zip_kings)))


```
the table below shows the top ten zipcodes in Queens Coonty for average house price

```{r include = TRUE, eval = TRUE, echo = FALSE, message = FALSE}
zip_queens= aggregate(df_housing.nona$Price,
                               by = list(df_housing.nona$county, df_housing.nona$zip),
                               FUN = mean)
colnames(zip_queens) = c('County', 'Zipcode', 'Average Price')
zip_queens  = zip_queens %>% filter (zip_queens$County == 'Queens')
top_ten_zip_queens= zip_queens %>% top_n (10)
top_ten_zip_queens = top_ten_zip_queens[order(-top_ten_zip_queens$`Average Price`), ]
knitr::kable(top_ten_zip_queens, col.names = gsub("[.]", " ", names(top_ten_zip_queens)))

```
# Conclusion
New York City is truly very diverse in terms of the house price, which ranges from US $ 40,000 to the US $ 80,000,000.  As expected, the most expensive county is New York, where the average house price is about above $ 6.5 million, followed by the Brooklyn , where the average house price is above 1 million.  The average price of the townhouse, which is approximately $ 4.8 million is the highest among all other types of houses, followed by condos, which cost about $ 2.4 million on an average. However, the price also depends on many other variables such as location, crime levels, number of schools, number of restaurants, groceries, etc. 
Based on our multivariate regression model, the number of bedrooms, and bathrooms, square feet of the house, number of schools, and level of nightlife in the neighborhood are the most important explanatory variables that can estimate the house price reasonably. The implication here is, that knowing this information which is easy to come by without having access to the data will educate the general public on a better estimation of house prices with little to no knowledge of data analysis. The level of nightlife came out to be an important variable not only because it is highly correlated with the number of restaurants and groceries in the neighborhood but also because it is the proxy of locations. Houses in the areas in such as Manhattan, and western Brooklyn, where the nightlife is very high, the price is very high in general. 
Generally, it is expected that the house prices also depend on the population because the population is the driving variable of economic activity that in turn affects house prices. However, our study, based on regression analysis, showed that there is no relationship between population and house prices in New York City.  This came out to be an interesting fact that contradicts our beliefs that the prices of houses are high where the population is dense. The one reason could be in New York County, where the house price is highest, the true number of its residents is less compared to that of other counties of NYC. People commute from other boroughs or even from different states to work and do other economic activities in Manhattan, but they do not live in Manhattan. Consequently, Manhattan has high economic activities which continuously increase house prices, despite a low number of actual residents. According to the census of 2020, Kings County has a population of 2,736,074. Likewise, Queens has 2,405,464. The Bronx has 1,472,654 and Richmond has 495,747. It could be true that there could be a positive correlation between house prices and population if we do not include New York County in the study. But as said, New York City is such a diverse city, even the less densely populated regions are very expensive. For example, Zip Code 11213 is Crown Heights and is one of the most densely populated regions in Kings and overall NYC, however, the average house price is much less than other zip codes in Kings that have a low population.
From our map analysis of average house prices by zip codes in New York City, Interestingly, there are three areas in Manhatten, which are west side of Central Park, Lower Manhatten having World Trade Center and the area where Empire State Building is located are the most expensive areas for housing. After Manhattan, where the average house price is highest, Brooklyn is the second most expensive in terms of housing, particularly, in western and northern Brooklyn, the price of houses is expensive.  In upper queens and some areas in lower and upper-west Bronx, houses are expensive. Staten Island is cheaper, followed by Bronx and Queens. The cheapest area is on the west side of Pelham Bay Park in the Bronx. 
Our machine learning model based on the K Nearest Neighbor algorithm to predict the crime level in New York City by using variables night life, number of schools, percentage of commute by car, and housing type did not perform well to predict the class of crime level. One reason for the poor performance is class imbalance.
Housing data analysis is applicable in the real world as it gives an insight to potential homeowners who are looking to buy a home with some specifications like house type, location, and how to match various prices with their budget. Also, knowledge about key variables that impact house prices helps regular buyers become better at evaluating house prices without resulting to real estate agencies and other brokers. Not only do buyers save some change on the capital, but they also save time as the information from this analysis is a road map that leads them to the destination of their housing type with specifics they are looking to own. Furthermore, real estate developers can take a cue from the housing demographics of NYC, how house prices are changing with time, and where and how to invest their capital. The City and Federal governments will need the results or information from the analysis of such data to decide on myriad housing development projects in various neighborhoods, to best tackle the NYC housing demand crisis. Finally, potential tenants will have the privilege of knowing which neighborhood matches their budget and where to look for what is affordable. It is obvious that there is a high correlation between house prices and monthly rent or mortgage. Housing in NYC, just like most developed cities is expensive and hard to come by, so vital information about house prices is priceless for lessees. To summarize, information from the analysis of housing data comes in handy ranging from government developmental projects to the lessee, to the real estate developer, and also to the potential homeowner -new to the housing market who wants to fulfill the objective of buying assets at the right price with less to no headaches.


